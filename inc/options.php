<?php// Display notice prompting for settingsfunction wp_ozh_yourls_admin_notice() {	global $plugin_page;	if( $plugin_page == 'ozh_yourls' ) {		$message = '<strong>YOURLS - WordPress</strong> configuration incomplete';	} else {		$url = menu_page_url( 'ozh_yourls', false );		$message = 'Please configure <strong>YOURLS - WordPress</strong> <a href="'.$url.'">settings</a> now';	}	$notice = <<<NOTICE	<div class="error"><p>$message</p></div>NOTICE;	echo apply_filters( 'ozh_yourls_notice', $notice );}// Add page to menufunction wp_ozh_yourls_add_page() {	// Loading CSS & JS *only* where needed. Do it this way too, goddamnit.	$page = add_options_page('YOURLS: WordPress', 'YOURLS', 'manage_options', 'ozh_yourls', 'wp_ozh_yourls_do_page');	add_action("load-$page", 'wp_ozh_yourls_add_css_js_plugin');	// Add the JS & CSS for the char counter. This is too early to check wp_ozh_yourls_generate_on('post') or ('page')	add_action('load-post.php', 'wp_ozh_yourls_add_css_js_post');	add_action('load-post-new.php', 'wp_ozh_yourls_add_css_js_post');	add_action('load-page.php', 'wp_ozh_yourls_add_css_js_post');	add_action('load-page-new.php', 'wp_ozh_yourls_add_css_js_post');}// Add style & JS on the plugin pagefunction wp_ozh_yourls_add_css_js_plugin() {	add_thickbox();	$plugin_url = WP_PLUGIN_URL.'/'.plugin_basename( dirname(dirname(__FILE__)) );	wp_enqueue_script('yourls_js', $plugin_url.'/res/yourls.js');	wp_enqueue_script('wp-ajax-response');	wp_enqueue_style('yourls_css', $plugin_url.'/res/yourls.css');}// Add style & JS on the Post/Page Edit pagefunction wp_ozh_yourls_add_css_js_post() {	global $pagenow;	$current = str_replace( array('-new.php', '.php'), '', $pagenow);	if ( wp_ozh_yourls_generate_on($current) ) {		$plugin_url = WP_PLUGIN_URL.'/'.plugin_basename( dirname(dirname(__FILE__)) );		wp_enqueue_script('yourls_js', $plugin_url.'/res/post.js');		wp_enqueue_style('yourls_css', $plugin_url.'/res/post.css');	}}// Sanitize & validate options that are submittedfunction wp_ozh_yourls_sanitize( $in ) {	global $wp_ozh_yourls;		// all options: sanitized strings	$in = array_map( 'esc_attr', $in);		// 0 or 1 for generate_on_*, tweet_on_*, link_on_*	foreach( $in as $key=>$value ) {		if( preg_match( '/^generate_on_/', $key ) ) {			$in[$key] = ( $value == 1 ? 1 : 0 );		}	}		return $in;}// Check if plugin seems configured. Param: 'overall' return one single bool, otherwise return detailsfunction wp_ozh_yourls_settings_are_ok( $check = 'overall' ) {	global $wp_ozh_yourls;		$check_yourls    = ( isset( $wp_ozh_yourls['service'] ) && !empty( $wp_ozh_yourls['service'] ) ? true : false );		if( $check == 'overall' ) {		$overall = $check_yourls;		return $overall;	} else {		return array( 'check_yourls' => $check_yourls );	}}// Draw the option pagefunction wp_ozh_yourls_do_page() {	$plugin_url = WP_PLUGIN_URL.'/'.plugin_basename( dirname(dirname(__FILE__)) );		$ozh_yourls = get_option('ozh_yourls'); 		extract( wp_ozh_yourls_settings_are_ok( 'all' ) ); // $check_yourls		// If only one of the 3 $check_ is false, expand that section, otherwise expand first	switch( intval( $check_yourls ) ) {		case 0:		case 3:			$script_expand = "jQuery('#h3_yourls').click();";			break;		case 1:		case 2:			if( !$check_yourls ) {				$script_expand = "jQuery('#h3_yourls').click();";			} else {				$script_expand = "jQuery('#h3_wordpress').click();";			}			break;	}		?>	<script>	jQuery(document).ready(function(){		toggle_ok_notok('#h3_check_yourls', '<?php echo $check_yourls ? 'ok' : 'notok' ; ?>' );		<?php echo $script_expand; ?>	});	</script>			<div class="wrap">			<?php /** ?>	<pre><?php print_r(get_option('ozh_yourls')); ?></pre>	<pre><?php print_r($_SESSION); ?></pre>	<?php /**/ ?>		<div class="icon32" id="icon-plugins"><br/></div>	<h2>YOURLS - WordPress</h2>		<div id="y_logo">		<div class="y_logo">			<a href="http://yourls.org/"><img src="<?php echo $plugin_url; ?>/res/yourls-logo.png"></a>		</div>		<div class="y_text">			<p><a href="http://yourls.org/">YOURLS</a> is a free URL shortener service you can run on your webhost to have your own personal TinyURL.</p>			<p>This plugin is a bridge between <a href="http://yourls.org/">YOURLS</a> and your blog: when you'll submit a new post or page, your blog will tap into YOURLS to generate a short URL for it.</p>			<p>Note that, for maximum fun, this plugin also supports a few other public URL shortener services: is.gd, tinyURL and bit.ly</p>		</div>	</div>		<form method="post" action="options.php">	<?php settings_fields('wp_ozh_yourls_options'); ?>	<h3>URL Shortener Settings <span class="h3_toggle expand" id="h3_yourls">+</span> <span id="h3_check_yourls" class="h3_check">*</span></h3>	<div class="div_h3" id="div_h3_yourls">	<table class="form-table">	<tr valign="top">	<th scope="row">URL Shortener Service<span class="mandatory">*</span></th>	<td>	<label for="y_service">You are using:</label>	<select name="ozh_yourls[service]" id="y_service" class="y_toggle">	<option value="" <?php selected( '', $ozh_yourls['service'] ); ?> >Please select..</option>	<option value="yourls" <?php selected( 'yourls', $ozh_yourls['service'] ); ?> >your own YOURLS install</option>	<option value="other" <?php selected( 'other', $ozh_yourls['service'] ); ?> >another public service such as TinyURL or bit.ly</option>	</select>		<?php $hidden = ( $ozh_yourls['service'] == 'yourls' ? '' : 'y_hidden' ) ; ?>	<div id="y_show_yourls" class="<?php echo $hidden; ?> y_service y_level2">		<label for="y_location">Your YOURLS installation is</label>		<select name="ozh_yourls[location]" id="y_location" class="y_toggle">		<option value="" <?php selected( '', $ozh_yourls['location'] ); ?> >Please select...</option>		<option value="local" <?php selected( 'local', $ozh_yourls['location'] ); ?> >local, on the same webserver</option>		<option value="remote" <?php selected( 'remote', $ozh_yourls['location'] ); ?> >remote, on another webserver</option>		</select>				<?php $hidden = ( $ozh_yourls['location'] == 'local' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_local" class="<?php echo $hidden; ?> y_location y_level3">			<label for="y_path">Path to YOURLS <tt>config.php</tt></label> <input type="text" class="y_longfield" id="y_path" name="ozh_yourls[yourls_path]" value="<?php echo $ozh_yourls['yourls_path']; ?>"/> <span id="check_path" class="yourls_check button">check</span><br/>			<em>Example: <tt>/home/you/site.com/yourls/includes/config.php</tt></em>		</div>				<?php $hidden = ( $ozh_yourls['location'] == 'remote' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_remote" class="<?php echo $hidden; ?> y_location y_level3">			<label for="y_url">URL to the YOURLS API</label> <input type="text" id="y_url" class="y_longfield" name="ozh_yourls[yourls_url]" value="<?php echo $ozh_yourls['yourls_url']; ?>"/> <span id="check_url" class="yourls_check button">check</span><br/>			<em>Example: <tt>http://site.com/yourls-api.php</tt></em><br/>			<label for="y_yourls_signature">YOURLS API Signature</label> <input type="text" id="y_yourls_signature" name="ozh_yourls[yourls_signature]" value="<?php echo $ozh_yourls['yourls_signature']; ?>"/><br/>		</div>		<?php		wp_nonce_field( 'yourls', '_ajax_yourls', false );		?>	</div>		<?php $hidden = ( $ozh_yourls['service'] == 'other' ? '' : 'y_hidden' ) ; ?>	<div id="y_show_other" class="<?php echo $hidden; ?> y_service y_level2">		<label for="y_other">Public service</label>		<select name="ozh_yourls[other]" id="y_other" class="y_toggle">		<option value="" <?php selected( '', $ozh_yourls['other'] ); ?> >Please select...</option>		<!--<option value="pingfm" <?php selected( 'pingfm', $ozh_yourls['other'] ); ?> >ping.fm</option>-->		<option value="bitly" <?php selected( 'bitly', $ozh_yourls['other'] ); ?> >bit.ly</option>		<option value="tinyurl" <?php selected( 'tinyurl', $ozh_yourls['other'] ); ?> >tinyURL</option>		<option value="isgd" <?php selected( 'isgd', $ozh_yourls['other'] ); ?> >is.gd</option>		</select>				<?php $hidden = ( $ozh_yourls['other'] == 'bitly' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_bitly" class="<?php echo $hidden; ?> y_other y_level3">			<label for="y_api_bitly_login">API Login</label> <input type="text" id="y_api_bitly_login" name="ozh_yourls[bitly_login]" value="<?php echo $ozh_yourls['bitly_login']; ?>"/> (case sensitive!)<br/>			<label for="y_api_bitly_pass">API Key</label> <input type="text" id="y_api_bitly_pass" class="y_longfield" name="ozh_yourls[bitly_password]" value="<?php echo $ozh_yourls['bitly_password']; ?>"/><br/>			<em>If you have a <a href="http://bit.ly/account/">bit.ly</a> account, entering your credentials will link the short URLs to it</em>		</div>		<?php $hidden = ( $ozh_yourls['other'] == 'pingfm' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_pingfm" class="<?php echo $hidden; ?> y_other y_level3">			<label for="y_api_pingfm_user_app_key">Web Key</label> <input type="text" id="y_api_pingfm_user_app_key" name="ozh_yourls[pingfm_user_app_key]" value="<?php echo $ozh_yourls['pingfm_user_app_key']; ?>"/><br/>			<em>If you have a <a href="http://ping.fm/">ping.fm</a> account, enter your private <a href="http://ping.fm/key/">Web Key</a></em>		</div>				<?php $hidden = ( $ozh_yourls['other'] == 'tinyurl' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_tinyurl" class="<?php echo $hidden; ?> y_other y_level3">			<em>(this service needs no authentication)</em>		</div>				<?php $hidden = ( $ozh_yourls['other'] == 'isgd' ? '' : 'y_hidden' ) ; ?>		<div id="y_show_isgd" class="<?php echo $hidden; ?> y_other y_level3">			<em>(this service needs no authentication)</em>		</div>			</div>	</td>	</tr>	</table>	</div><!-- div_h3_yourls -->			<h3>WordPress settings <span class="h3_toggle expand" id="h3_wordpress">+</span> <span id="h3_check_wordpress" class="h3_check">*</span></h3> 	<div class="div_h3" id="div_h3_wordpress">	<h4>When to generate a short URL</h4> 		<table class="form-table">	<?php	$types = get_post_types( array('publicly_queryable' => 1 ), 'objects' );	foreach( $types as $type=>$object ) {		$name = $object->labels->singular_name		?>		<tr valign="top">		<th scope="row">New <strong><?php echo $name; ?></strong> published</th>		<td>		<input class="y_toggle" id="generate_on_<?php echo $type; ?>" name="ozh_yourls[generate_on_<?php echo $type; ?>]" type="checkbox" value="1" <?php checked( '1', $ozh_yourls['generate_on_'.$type] ); ?> /><label for="generate_on_<?php echo $type; ?>"> Generate short URL</label><br/>		<?php $hidden = ( $ozh_yourls['generate_on_'.$type] == '1' ? '' : 'y_hidden' ) ; ?>		<?php if( $type != 'attachment' ) { ?>		<?php } ?>		</td>		</tr>	<?php } ?>	</table>	</div> <!-- div_h3_wordpress -->		<?php	$reset = add_query_arg( array('action' => 'reset'), menu_page_url( 'ozh_yourls', false ) );	$reset = wp_nonce_url( $reset, 'reset-yourls' );	?>	<p class="submit">	<input type="submit" class="button-primary y_submit" value="<?php _e('Save Changes') ?>" />	<?php echo "<a href='$reset' id='reset-yourls' class='submitdelete'>Reset</a> all settings"; ?>	</p>		<p><small><span class="mandatory">*</span> denotes a mandatory field. Click on the <img src="<?php echo $plugin_url; ?>/res/expand.png" /> to expand a setting section. </small></p>	</form>	</div> <!-- wrap -->		<?php	}// Add meta boxes to post & page editfunction wp_ozh_yourls_addbox() {	// What page are we on? (new Post, new Page, new custom post type?)	$post_type = isset( $_GET['post_type'] ) ? $_GET['post_type'] : 'post' ;	add_meta_box( 'yourlsdiv', 'YOURLS', 'wp_ozh_yourls_drawbox', $post_type, 'side', 'default' );		// TODO: do something with links. Or wait till they're considered custom post types.}// Draw meta boxfunction wp_ozh_yourls_drawbox( $post ) {	$type = $post->post_type;	$status = $post->post_status;	$id = $post->ID;	$title = $post->post_title;		// Too early, young Padawan	if ( $status != 'publish' ) {		echo '<p>Depending on <a href="options-general.php?page=ozh_yourls">configuration</a>, a short URL will be generated.</p>';		return;	}		$shorturl = wp_ozh_yourls_geturl( $id );	// Bummer, could not generate a short URL	if ( !$shorturl ) {		echo '<p>Bleh. The URL shortening service you configured could not be reached as of now. This might be a temporary problem, please try again later!</p>';		return;	}		// YOURLS part:		wp_nonce_field( 'yourls', '_ajax_yourls', false );	echo '	<input type="hidden" id="yourls_post_id" value="'.$id.'" />	<input type="hidden" id="yourls_shorturl" value="'.$shorturl.'" />	';		echo '<p><strong>Short URL</strong></p>';	echo '<div id="yourls-shorturl">';		echo "<p>This $type's short URL: <strong><a href='$shorturl'>$shorturl</a></strong></p>	<p>You can click Reset to generate another short URL if you picked another URL shortening service in the <a href='options-general.php?page=ozh_yourls'>plugin options</a></p>";	echo '<p style="text-align:right"><input class="button" id="yourls_reset" type="submit" value="Reset short URL" /></p>';	echo '</div>';	}?>